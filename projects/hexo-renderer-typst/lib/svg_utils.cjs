const ignoredEvent=function(){const t={};let e,n;return function(o,r,a){n=new Date().getTime(),a=a||"ignored event",e=t[a]?n-t[a]:n,e>r&&(t[a]=n,o())}}(),fc=(t,e)=>{const n=[];for(let o=0;o<t.length;o++){const r=t[o];e(r)&&n.push(r)}return n},overLappingBox=(t,e)=>!(t.right<e.left||t.left>e.right||t.bottom<e.top||t.top>e.bottom),almostOverLapping=(t,e)=>{const n=t.getBoundingClientRect(),o=e.getBoundingClientRect();return overLappingBox(n,o)&&Math.abs(n.left-o.left)+Math.abs(n.right-o.right)<.5*Math.max(n.width,o.width)&&Math.abs(n.bottom-o.bottom)+Math.abs(n.top-o.top)<.5*Math.max(n.height,o.height)},gr=window.typstGetRelatedElements=t=>{let e=t.relatedElements;return e==null&&(e=t.relatedElements=searchIntersections(t)),e},getRelatedElements=t=>gr(t.target),findAncestor=(t,e)=>{for(;t&&!t.classList.contains(e);)t=t.parentElement;return t};function findGlyphListForText(t){const e=findAncestor(t,"typst-text");return e&&fc(e.children,n=>n.tagName==="use")}const searchIntersections=function(t){const e=findAncestor(t,"typst-group");return e&&fc(e.children,n=>almostOverLapping(n,t))};function nextNode(t){if(t.hasChildNodes())return t.firstChild;for(;t&&!t.nextSibling;)t=t.parentNode;return t?t.nextSibling:null}function getRangeSelectedNodes(t,e){var n=t.startContainer,o=t.endContainer;if(n==o){if(e(n))return[n];if(e(n.parentElement))return[n.parentElement]}for(var r=[];n&&n!=o;)n=nextNode(n),e(n)&&r.push(n);for(n=t.startContainer;n&&n!=t.commonAncestorContainer;)e(n)&&r.unshift(n),n=n.parentNode;return r}function getSelectedNodes(t){if(window.getSelection){var e=window.getSelection();if(!e.isCollapsed){if(e.rangeCount===1)return getRangeSelectedNodes(e.getRangeAt(0),t);let n=[];for(let o=0,r=e.rangeCount;o<r;o++)n.push(...getRangeSelectedNodes(e.getRangeAt(o),t));return n}}return[]}function getGlyphLenShape(t){return t.map(e=>{const n=e.getAttribute("href"),o=document.getElementById(n.slice(1));return 1+Number.parseInt(o?.getAttribute("data-liga-len")||"0")})}function getGlyphAdvanceShape(t){return t.map(e=>Number.parseInt(e.getAttribute("x")||"0"))}const linkmove=t=>ignoredEvent(()=>gr(t)?.forEach(e=>e.classList.add("hover")),200,"mouse-move"),linkleave=t=>gr(t)?.forEach(e=>e.classList.remove("hover")),semaLinkEnter=(t,e)=>()=>{const n=e.parentElement?.getAttribute("href")||e.parentElement?.getAttribute("xlink:href");t.getAttribute("href")!==n&&t.setAttribute("href",n||"")};window.typstProcessSvg=function(t,e){for(var n=t.getElementsByClassName("pseudo-link"),o=0;o<n.length;o++){var r=n[o];r.addEventListener("mousemove",f=>linkmove(f.target)),r.addEventListener("mouseleave",f=>linkleave(f.target))}if((e?.layoutText??!0)&&setTimeout(()=>{const f=document.createElement("style");f.innerHTML=`.tsel { font-family: monospace; text-align-last: left !important; -moz-text-size-adjust: none; -webkit-text-size-adjust: none; text-size-adjust: none; overflow: hidden; }
.tsel span { position: relative !important; width: fit-content !important;  }`,document.getElementsByTagName("head")[0].appendChild(f),window.layoutText(t)},0),t.addEventListener("click",f=>{let h=f.target;for(;h;){const b=h.getAttribute("data-span");if(b){console.log("source-span of this svg element",b);const c=document.body||document.firstElementChild,T=c.getBoundingClientRect(),m=window.innerWidth||0,S=f.clientX-T.left+.015*m,C=f.clientY-T.top+.015*m;triggerRipple(c,S,C,"typst-debug-react-ripple","typst-debug-react-ripple-effect .4s linear");return}h=h.parentElement}}),window.location.hash){const h=window.location.hash.split("-");if(h.length===2&&h[0]==="#loc"){const b=h[1].split("x");if(b.length===3){const c=Number.parseInt(b[0]),T=Number.parseFloat(b[1]),m=Number.parseFloat(b[2]);window.handleTypstLocation(t,c,T,m)}}}};const LB=`
`.codePointAt(0);window.layoutText=async function(t){const e=Array.from(t.querySelectorAll(".tsel, .typst-content-hint, .pseudo-link")),n=performance.now(),o=document.createElementNS("http://www.w3.org/1999/xhtml","canvas").getContext("2d");o.font="128px monospace";const r=o.measureText("A").width,a=t.getBoundingClientRect(),f=a.left+window.scrollX,h=a.top+window.scrollY,b=(d,y,u)=>{var s=d.getScreenCTM();return s?{x:s.a*y+s.c*u+s.e-f,y:s.b*y+s.d*u+s.f-h}:{x:0,y:0}};let c;const T=t.parentElement;if(!T)c=void 0;else if(t.nextElementSibling?.classList.contains("typst-semantic-layer"))c=t.nextElementSibling;else{c=document.createElement("div");const d=document.createElement("div");d.style.position="relative",T.replaceChild(d,t),d.appendChild(t),d.appendChild(c),c.classList.add("typst-semantic-layer"),c.style.position="absolute",c.style.left="0",c.style.top="0",c.style.zIndex="1",c.style.float="left";const y=t.getAttribute("width");c.style.width=`${y}px`;const u=t.getAttribute("height");c.style.height=`${u}px`}let m={left:0,right:0,bottom:0,top:0},S=[];const C=(d,y="span")=>{const u=document.createElement(y),s=d.getBBox(),l=b(d,s.x,s.y),i=b(d,s.x+s.width,s.y+s.height),v=Math.min(l.x,i.x)+window.scrollX,E=Math.min(l.y,i.y)+window.scrollY,x=Math.abs(l.x-i.x),M=Math.abs(l.y-i.y),w=M/2,L={left:v-w,top:E-w,right:v+x+w,bottom:E+M+w};return overLappingBox(m,L)?(m.left=Math.min(m.left,L.left),m.top=Math.min(m.top,L.top),m.right=Math.max(m.right,L.right),m.bottom=Math.max(m.bottom,L.bottom)):(S.push([u,m]),m=L),u.classList.add("tsel"),u.style.position="absolute",u.style.left=`${v}px`,u.style.top=`${E}px`,u.style.width=`${x}px`,u.style.height=`${M}px`,u},A=!1,N=(d,y)=>{const u=e.slice(d,y);for(let s of u){const l=s.parentElement;if(c){if(s.classList.contains("typst-content-hint")){const i=C(s);i.style.fontSize="0.1px",i.style.width="0.1px",i.style.height="0.1px";const p=Number.parseInt(s.getAttribute("data-hint")||"0",16)||LB;i.innerHTML=p===LB?"<br/>":`&#x${p.toString(16)};`,c.append(i);continue}else if(s.classList.contains("pseudo-link")){const i=C(s,"a");i.style.cursor="pointer",i.addEventListener("mousemove",()=>linkmove(s)),i.addEventListener("mouseleave",()=>linkleave(s)),i.onclick=()=>{s.dispatchEvent(new MouseEvent("click",{bubbles:!0}))},i.addEventListener("mouseenter",()=>{const p=s.parentElement?.getAttribute("href")||s.parentElement?.getAttribute("xlink:href");i.getAttribute("href")!==p&&i.setAttribute("href",p||"")}),c.append(i);continue}}if(s.style.fontSize){const i=[],p=s.innerText,v=r*Number.parseFloat(s.style.fontSize)/128;if(A){const g=document.createElement("span");g.textContent=p;const E=l.getBBox(),x=v*p.length;if(l){const M=E.width/x;g.style.display="inline-block",g.style.transform=`scaleX(${M})`,g.style.transformOrigin="left"}i.push(g)}else{const g=findGlyphListForText(s);if(!g)continue;const E=getGlyphLenShape(g),x=getGlyphAdvanceShape(g).map($=>$/16);let M=!1,w=0,L=0,V=0,H,k=0;for(let $ of p){if(w>=x.length){M=!0;break}let R=x[w];E[w]>1&&(R+=L*v),L++,L>=E[w]&&(w++,L=0);const G=document.createElement("span");G.textContent=$,G.classList.add("tsel-tok"),H&&(H.style.letterSpacing=`${R-k-v}px`),H=G,k=R,i.push(G),V+=1}if(M)continue}if(s.innerHTML="",c){const g=Number.parseFloat(s.style.fontSize||"0"),E=Math.abs(b(l,0,g).y-b(l,0,0).y);if(!A){const M=E/g;for(let w of i)w.style.letterSpacing=`${Number.parseFloat(w.style.letterSpacing||"0")*M}px`}const x=C(l);x.style.fontSize=`${E}px`,x.append(...i),c.append(x)}else s.append(...i)}}console.log(`layoutText ${e.length} elements used since ${performance.now()-n} ms`)},B=100;for(let d=0;d<e.length;d+=B){const y=d;await new Promise(u=>{setTimeout(()=>{N(y,y+B),u(void 0)})})}if(c&&m.right!=0&&S.push([null,m]),c){const d=performance.now(),y=["red","green","blue","purple","orange"];let u=0;for(let[s,l]of S){if(u<S.length-1){let p=S[u+1][1],v=l.left<p.left,g=l.top<p.top,E=l.right<p.right,x=l.bottom<p.bottom;v!=E&&(l.left=Math.min(l.left,p.left),l.right=Math.max(l.right,p.right)),g!=x&&(l.top=Math.min(l.top,p.top),l.bottom=Math.max(l.bottom,p.bottom))}const i=document.createElement("span");i.style.zIndex="-1",i.style.position="absolute",i.style.left=`${l.left}px`,i.style.top=`${l.top}px`,i.style.width=`${l.right-l.left}px`,i.style.height=`${l.bottom-l.top}px`,i.dir="ltr",i.style.unicodeBidi="isolated",c.insertBefore(i,s),u++}console.log(`layout paragraph used since ${performance.now()-d} ms`)}},window.handleTypstLocation=function(t,e,n,o,r){if(t.classList.contains("typst-semantic-layer"))return t=t.firstElementChild,t&&window.handleTypstLocation(t,e,n,o,r);const a=r?.behavior||"smooth",f=window.assignSemaHash||((m,S,C)=>{location.hash=`loc-${m}x${S.toFixed(2)}x${C.toFixed(2)}`});let h=t;const b=m=>{const S=window.innerWidth*.01,C=window.innerHeight*.01,A=Number.parseFloat(h.getAttribute("data-width")||h.getAttribute("width")||"0")||0,N=Number.parseFloat(h.getAttribute("data-height")||h.getAttribute("height")||"0")||0,B=h.getBoundingClientRect(),d={left:B.left,top:B.top,width:B.width,height:B.height},y=7*S,u=38.2*C,s=m.transform?.baseVal?.consolidate()?.matrix;s&&(d.left+=s.e/A*d.width,d.top+=s.f/N*d.height);const l=document.body||document.firstElementChild,i=l.getBoundingClientRect(),p=d.left-i.left+n/A*d.width-y,v=d.top-i.top+o/N*d.height-u,g=p+y,E=v+u;window.scrollTo({behavior:a,left:p,top:v}),a!=="instant"&&triggerRipple(l,g,E,"typst-jump-ripple","typst-jump-ripple-effect .4s linear"),f(e,n,o)};if(r?.isDom){b(h);return}if(h=findAncestor(t,"typst-doc"),!h){console.warn("no typst-doc or typst-svg-page found",t);return}const c=h.children;let T=0;for(let m=0;m<c.length;m++)(c[m].tagName==="g"||c[m].tagName==="stub")&&T++,T==e&&b(c[m])};function triggerRipple(t,e,n,o,r){const a=document.createElement("div");a.className=o,a.style.left=`${e}px`,a.style.top=`${n}px`,t.appendChild(a),a.style.animation=r,a.onanimationend=()=>{t.removeChild(a)}}var scriptTag=document.currentScript;if(scriptTag){console.log("new svg util updated 37  ",performance.now());const t=findAncestor(scriptTag,"typst-doc");t&&window.typstProcessSvg(t)}function findLinkInSvg(t,e,n){const o=t.getBoundingClientRect();if(!(e[0]<o.left-1||e[0]>o.right+1||e[1]<o.top-1||e[1]>o.bottom+1)){if(t.classList.contains("pseudo-link"))return t;for(let r=0;r<t.children.length;r++){const a=findLinkInSvg(t.children[r],e,n);if(a)return a}}}window.typstBindSemantics=function(t,e,n){"typstBindCustomSemantics"in window&&window.typstBindCustomSemantics(t,e,n),n.addEventListener("mousemove",o=>{ignoredEvent(()=>{if(o.target?.tagName==="A"){const r=o.target;if(r.cachedTarget)return;const a=findLinkInSvg(e,[o.clientX,o.clientY],o.target);if(a){a.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0}));const f=semaLinkEnter(a,r);r.addEventListener("mouseenter",()=>{a.dispatchEvent(new MouseEvent("mouseenter",{bubbles:!0})),f()}),r.addEventListener("mousemove",()=>{a.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0})),linkmove(a)}),r.addEventListener("mouseleave",()=>{a.dispatchEvent(new MouseEvent("mouseleave",{bubbles:!0})),linkleave(a)})}}},100,"mouseenter")})};
